CREATE TABLE WRITE_OFF_INFO_TEMP (
  WRITE_OFF_ID varchar(25) DEFAULT '',
  CONTRACT_NUMBER varchar(25) DEFAULT '' COMMENT '合同编号',
  CONTRACT_STATUS_DESC varchar(25) DEFAULT '' COMMENT '合同状态',
  BP_ID_TENANT varchar(20) DEFAULT '',
  BP_NAME varchar(200) DEFAULT '' COMMENT '合同客户名',
  CF_ITEM varchar(25) DEFAULT '' COMMENT '核销现金流',
  CF_ITEM_N varchar(200) DEFAULT '' COMMENT '核销现金流',
  WRITE_OFF_DUE_AMOUNT decimal(12,2) COMMENT '核销金额',
  WRITE_OFF_PRINCIPAL decimal(12,2) COMMENT '核销本金',
  WRITE_OFF_INTEREST decimal(12,2) COMMENT '核销利息',
  DUE_DATE_C timestamp COMMENT '应收日期',
  TIMES varchar(25) DEFAULT '' COMMENT '核销期数',
  LEASE_TIMES varchar(25) DEFAULT '' ,
  TRANSACTION_DATE_C timestamp COMMENT '收款日期',
  WRITE_OFF_DATE_C timestamp COMMENT '核销基准日',
  JOURNAL_DATE_C timestamp COMMENT '核销日期',
  BANK_BRANCH_NAME varchar(25) DEFAULT '' COMMENT '收款银行名称',
  TRANSACTION_NUM varchar(200) DEFAULT '' COMMENT '现金事务编号',
  BP_BANK_ACCOUNT_NAME varchar(30) DEFAULT '' COMMENT '对方账户',
  TRANSACTION_TYPE varchar(25) DEFAULT '' COMMENT '事务类型',
  TRANSACTION_TYPE_N varchar(200) DEFAULT '' COMMENT '事务类型',
  RECEIPT_TYPE varchar(25) DEFAULT '' COMMENT '收款类型',
  RECEIPT_TYPE_N varchar(200) DEFAULT '' COMMENT '收款类型',
  WRITE_OFF_TYPE varchar(25) DEFAULT '' COMMENT '核销类型',
  WRITE_OFF_TYPE_N varchar(200) DEFAULT '' COMMENT '核销类型',
  WRITE_OFF_CLASSIFICATION varchar(25) DEFAULT '' COMMENT '核销分类',
  WRITE_OFF_CLASSIFICATION_N varchar(200) DEFAULT '' COMMENT '核销分类',
  COLLECTION_CLASSES varchar(25) DEFAULT '' COMMENT '款项分类',
  COLLECTION_CLASSES_N varchar(200) DEFAULT '' COMMENT '款项分类',
  REVERSED_FLAG varchar(25) DEFAULT '' COMMENT '反冲标志',
  REVERSED_FLAG_N varchar(200) DEFAULT '' COMMENT '反冲标志',
  REVERSED_DATE timestamp COMMENT '反冲日期',
  DESCRIPTION varchar(200) DEFAULT '' COMMENT '收款备注',
  BP_ID_AGENT_LEVEL1 varchar(25) DEFAULT '' COMMENT '合同代理商',
  BP_ID_AGENT_LEVEL1_N varchar(200) DEFAULT '' COMMENT '合同代理商',
  WRITE_OFF_DES varchar(200) DEFAULT '' COMMENT '核销备注',
  JOURNAL_NUM varchar(200) DEFAULT '' COMMENT '凭证编号',
  SAP_BELNR varchar(200) DEFAULT '' ,
  CREATED_BY varchar(25) DEFAULT '' COMMENT '提交人',
  CREATED_BY_N varchar(200) DEFAULT '' COMMENT '提交人',
  CREATE_TIME timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  UPDATED_BY int(10) DEFAULT NULL,
  UPDATE_TIME timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB AUTO_INCREMENT=10783 DEFAULT CHARSET=utf8 COMMENT='核销事务查询临时表';


SELECT
  WRITE_OFF_ID,
  CONTRACT_NUMBER,
  CONTRACT_STATUS_DESC,
  BP_ID_TENANT,
  BP_NAME,
  CF_ITEM,
  CF_ITEM_N,
  WRITE_OFF_DUE_AMOUNT,
  WRITE_OFF_PRINCIPAL,
  WRITE_OFF_INTEREST,
  DUE_DATE_C,
  TIMES,
  LEASE_TIMES,
  TRANSACTION_DATE_C,
  WRITE_OFF_DATE_C,
  JOURNAL_DATE_C,
  BANK_BRANCH_NAME,
  TRANSACTION_NUM,
  BP_BANK_ACCOUNT_NAME,
  TRANSACTION_TYPE,
  TRANSACTION_TYPE_N,
  RECEIPT_TYPE,
  RECEIPT_TYPE_N,
  WRITE_OFF_TYPE,
  WRITE_OFF_TYPE_N,
  WRITE_OFF_CLASSIFICATION,
  WRITE_OFF_CLASSIFICATION_N,
  COLLECTION_CLASSES,
  COLLECTION_CLASSES_N,
  REVERSED_FLAG,
  REVERSED_FLAG_N,
  REVERSED_DATE,
  DESCRIPTION,
  BP_ID_AGENT_LEVEL1,
  BP_ID_AGENT_LEVEL1_N,
  WRITE_OFF_DES,
  JOURNAL_NUM,
  SAP_BELNR,
  CREATED_BY,
  CREATED_BY_N
FROM WRITE_OFF_QUERY_V


--SAAS 创建视图
CREATE VIEW WRITE_OFF_INFO_V
AS
SELECT
  A.WRITE_OFF_ID,
  A.CONTRACT_NUMBER,
  A.CONTRACT_STATUS_DESC,
  A.BP_ID_TENANT,
  A.BP_NAME,
  A.CF_ITEM,
  A.CF_ITEM_N,
	(SELECT WEEKLY_NAME
	FROM DCFL_WEEKLY_CLASSIFICATION B
	WHERE B.CASHFLOW_NAME = A.CF_ITEM_N) AS CASHFLOW_NAME,
  A.WRITE_OFF_DUE_AMOUNT,
  A.WRITE_OFF_PRINCIPAL,
  A.WRITE_OFF_INTEREST,
  A.DUE_DATE_C,
  A.TIMES,
  A.LEASE_TIMES,
  A.TRANSACTION_DATE_C,
  A.WRITE_OFF_DATE_C,
  A.JOURNAL_DATE_C,
  A.BANK_BRANCH_NAME,
  A.TRANSACTION_NUM,
  A.BP_BANK_ACCOUNT_NAME,
  A.TRANSACTION_TYPE,
  A.TRANSACTION_TYPE_N,
  A.RECEIPT_TYPE,
  A.RECEIPT_TYPE_N,
  A.WRITE_OFF_TYPE,
  A.WRITE_OFF_TYPE_N,
  A.WRITE_OFF_CLASSIFICATION,
  A.WRITE_OFF_CLASSIFICATION_N,
  A.COLLECTION_CLASSES,
  A.COLLECTION_CLASSES_N,
  A.REVERSED_FLAG,
  A.REVERSED_FLAG_N,
  A.REVERSED_DATE,
  A.DESCRIPTION,
  A.BP_ID_AGENT_LEVEL1,
  A.BP_ID_AGENT_LEVEL1_N,
  A.WRITE_OFF_DES,
  A.JOURNAL_NUM,
  A.SAP_BELNR,
  A.CREATED_BY,
  A.CREATED_BY_N
FROM WRITE_OFF_INFO_TEMP A
WHERE 1 = 1
AND A.WRITE_OFF_TYPE = 'RECEIPT_CREDIT'  #收款核销债权
AND A.REVERSED_FLAG = 'N'  #未反冲
AND A.CONTRACT_STATUS_DESC IN ('起租', '损失担保结清', '正常结清', '提前结清完成', '正常结清')


#报表统计
SELECT A.CASHFLOW_NAME,
       SUM(A.WRITE_OFF_DUE_AMOUNT) AS WRITE_OFF_DUE_AMOUNT,
			 SUM(A.WRITE_OFF_PRINCIPAL) AS WRITE_OFF_PRINCIPAL,
			 SUM(A.WRITE_OFF_INTEREST) AS WRITE_OFF_INTEREST
FROM WRITE_OFF_INFO_V A
GROUP BY A.CASHFLOW_NAME
ORDER BY A.CASHFLOW_NAME DESC



#HISTORY
CREATE TABLE WRITE_OFF_INFO_HISTORY
AS
SELECT * FROM WRITE_OFF_INFO_TEMP
WHERE 1 = 2